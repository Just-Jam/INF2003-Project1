{% extends 'base.html' %}
{% block title %}Register{% endblock %}
{% block content %}
<div class="row justify-content-center">
  <div class="col-md-6">
    <div class="card">
      <div class="card-body">
        <h2 class="card-title text-center mb-4">Create Account</h2>
        <form id="regForm">
          {% csrf_token %}
          <div class="mb-3">
            <label class="form-label">Email</label>
            <input type="email" class="form-control" name="email" required
                   placeholder="Enter your email">
          </div>
          <div class="mb-3">
            <label class="form-label">First Name</label>
            <input type="text" class="form-control" name="first_name" required
                   placeholder="Enter your first name">
          </div>
          <div class="mb-3">
            <label class="form-label">Last Name</label>
            <input type="text" class="form-control" name="last_name" required
                   placeholder="Enter your last name">
          </div>
          <div class="mb-3">
            <label class="form-label">Password</label>
            <input type="password" class="form-control" name="password" required
                   placeholder="Create a password" minlength="8">
            <div class="form-text">Password must be at least 8 characters long.</div>
          </div>
          <div class="mb-3">
            <label class="form-label">Confirm Password</label>
            <input type="password" class="form-control" name="password_confirm" required
                   placeholder="Confirm your password">
          </div>
          <button type="submit" class="btn btn-primary w-100" id="submitBtn">
            Create Account
          </button>
          <div id="error" class="alert alert-danger mt-3" style="display: none;"></div>
        </form>

        <div class="text-center mt-3">
          <p>Already have an account? <a href="{% url 'login' %}">Login here</a></p>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.getElementById('regForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  const submitBtn = document.getElementById('submitBtn');
  const errorDiv = document.getElementById('error');
  const formData = Object.fromEntries(new FormData(e.target).entries());

  // Clear previous errors
  errorDiv.style.display = 'none';
  errorDiv.textContent = '';

  // Show loading state
  submitBtn.disabled = true;
  submitBtn.textContent = 'Creating Account...';

  try {
    // Use the updated auth system - note the field names match the serializer
    const response = await window.auth.register({
      email: formData.email,
      first_name: formData.first_name,
      last_name: formData.last_name,
      password: formData.password,
      password_confirm: formData.password_confirm
    });

    // Success - redirect to profile page
    window.location.href = "{% url 'profile' %}";

  } catch (err) {
    // Show error message - handle different error formats
    let errorMessage = 'Registration failed. Please try again.';

    if (err.detail) {
      errorMessage = err.detail;
    } else if (err.email) {
      errorMessage = err.email[0];
    } else if (err.password) {
      errorMessage = err.password[0];
    } else if (err.first_name) {
      errorMessage = err.first_name[0];
    } else if (err.last_name) {
      errorMessage = err.last_name[0];
    } else if (err.non_field_errors) {
      errorMessage = err.non_field_errors[0];
    }

    errorDiv.textContent = errorMessage;
    errorDiv.style.display = 'block';

    console.error('Registration error:', err);
  } finally {
    // Reset button state
    submitBtn.disabled = false;
    submitBtn.textContent = 'Create Account';
  }
});

// Real-time password confirmation validation
document.querySelector('input[name="password_confirm"]')?.addEventListener('input', function() {
  const password = document.querySelector('input[name="password"]').value;
  const confirmPassword = this.value;
  const errorDiv = document.getElementById('error');

  if (confirmPassword && password !== confirmPassword) {
    errorDiv.textContent = 'Passwords do not match.';
    errorDiv.style.display = 'block';
  } else if (errorDiv.textContent === 'Passwords do not match.') {
    errorDiv.style.display = 'none';
  }
});

// Initialize auth if not already loaded
document.addEventListener('DOMContentLoaded', function() {
  if (!window.auth) {
    console.error('Auth system not loaded. Make sure auth.js is included in base.html');
  }
});
</script>
{% endblock %}